---
description: "Create Pull Request and request human review. Triggers: /pr, /autopilot-pr, 'create pr', 'open pr', 'ship it'"
model: claude-3-5-haiku
tools: ["Read", "Write", "Bash"]
---

# Autopilot PR - Ship Changes

## Purpose

Act as a **Senior Analytics Engineer** to hand off work to the team.
Your goal is to present a clear, reviewable Pull Request that respects the project's contract.

## When to Use

- User runs `/autopilot:pr`
- Orchestrator (`/launch`) detects `review` stage completed
- User asks to "open PR" or "push changes"

## Execution Flow

### 1. Load State

Verify review is complete:

```bash
if [ ! -f ".autopilot/state.json" ]; then
  echo "❌ ERROR: No state file found."
  exit 1
fi

STAGE=$(jq -r '.stage' .autopilot/state.json)
if [ "$STAGE" != "review" ] && [ "$STAGE" != "pr" ]; then
  echo "❌ ERROR: Review stage not completed (current stage: $STAGE)."
  exit 1
fi
```

### 2. Push to Origin

Push the task branch:

```bash
BRANCH=$(jq -r '.branch' .autopilot/state.json)
echo "Pushing branch $BRANCH to origin..."

# SAFETY: No force-push (SAFETY-04)
git push origin "$BRANCH"

if [ $? -ne 0 ]; then
  echo "❌ ERROR: Failed to push branch to origin."
  exit 1
fi
```

### 3. Generate PR Description

Use state and task metadata to generate a comprehensive PR description:

```bash
TASK_ID=$(jq -r '.task_id' .autopilot/state.json)
SUMMARY=$(jq -r '.summary' .autopilot/task.json)
CLASSIFICATION=$(jq -r '.classification' .autopilot/state.json)
AFFECTED_MODELS=$(jq -r '.signals.affected_models | join(", ")' .autopilot/classification.json)

PR_TITLE="Feat - $TASK_ID – $SUMMARY"

# Create PR body from template
cat <<EOF > .autopilot/pr_body.md
## Context
Linked JIRA: [$TASK_ID](https://jira.company.com/browse/$TASK_ID)

## Summary of Changes
$SUMMARY

## Classification
- Level: $CLASSIFICATION
- Affected Models: $AFFECTED_MODELS

## Validation Results
- dbt build: ✅ Passed
- SQL Linting: ✅ Passed
- Tests: All green

## Confidence Level
- High (Autopilot validated)

---
*Generated by AE Autopilot*
EOF
```

### 4. Create Pull Request

Use GitHub CLI (gh) to create the PR:

```bash
echo "Creating Pull Request..."
gh pr create --title "$PR_TITLE" --body-file .autopilot/pr_body.md --draft

if [ $? -ne 0 ]; then
  echo "❌ ERROR: Failed to create PR."
  exit 1
fi

PR_URL=$(gh pr view --json url -q .url)
echo "✅ PR Created: $PR_URL"
```

### 5. Update State & Close

Mark task as complete:

```bash
jq --arg url "$PR_URL" \
   '.stage = "pr" | .execution.status = "completed" | .pr_url = $url | .timestamps.last_updated = now | strftime("%Y-%m-%dT%H:%M:%SZ")' \
   .autopilot/state.json > .autopilot/state.json.tmp && mv .autopilot/state.json.tmp .autopilot/state.json
```

### 6. Final Report

```bash
echo ""
echo "✅ Mission Accomplished"
echo "   Task: $TASK_ID"
echo "   PR: $PR_URL"
echo ""
echo "Autopilot is standing down. Awaiting human review."
echo ""
```

## Safety Rules Applied

✅ No force-push (SAFETY-04)
✅ Template-driven PR (PR-01)
✅ JIRA linkage (GIT-01)

## See Also
- `shared/schemas/state-schema.json`
- `.cursor/rules/autopilot-core.mdc`